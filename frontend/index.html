<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QRShield â€” Secure Attendance</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap');
:root {
  --bg:#0a0a0f; --surface:#111118; --surface2:#1a1a24; --border:#2a2a3a;
  --accent:#00ff88; --accent2:#ff3366; --accent3:#3388ff;
  --text:#e8e8f0; --muted:#666680; --warning:#ffaa00;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;letter-spacing:-0.01em;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 60% 40% at 10% 20%,rgba(0,255,136,0.04) 0%,transparent 60%),radial-gradient(ellipse 50% 50% at 90% 80%,rgba(51,136,255,0.04) 0%,transparent 60%);pointer-events:none;z-index:0;}
.grid-bg{position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
.app{position:relative;z-index:1;}
header{padding:18px 40px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(10,10,15,0.85);backdrop-filter:blur(20px);position:sticky;top:0;z-index:100;}
.logo{font-size:1.3rem;font-weight:800;display:flex;align-items:center;gap:10px;}
.logo-icon{width:30px;height:30px;background:var(--accent);border-radius:7px;display:grid;place-items:center;font-size:14px;}
.logo span{color:var(--accent);}
.hdr-right{display:flex;align-items:center;gap:16px;font-family:'Outfit',sans-serif;font-size:0.75rem;color:var(--muted);letter-spacing:0.04em;}
.dot{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,255,136,0.4);}50%{box-shadow:0 0 0 6px rgba(0,255,136,0);}}
.view{display:none;} .view.active{display:block;}
/* AUTH */
.auth-wrap{min-height:calc(100vh - 61px);display:flex;align-items:center;justify-content:center;padding:40px 20px;}
.auth-box{width:100%;max-width:420px;}
.auth-hero{text-align:center;margin-bottom:40px;}
.auth-hero h1{font-size:2.6rem;font-weight:800;line-height:1.1;margin-bottom:12px;letter-spacing:-0.03em;}
.auth-hero h1 em{font-style:normal;color:var(--accent);}
.auth-hero p{color:var(--muted);font-size:0.9rem;line-height:1.6;}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;}
.fg{margin-bottom:18px;}
.fg label{display:block;font-size:0.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
.fg input{width:100%;padding:13px 15px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'Sora',sans-serif;font-size:0.93rem;outline:none;transition:border-color 0.2s;}
.fg input:focus{border-color:var(--accent);}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:13px 24px;border:none;border-radius:9px;font-family:'Outfit',sans-serif;font-weight:700;font-size:0.93rem;cursor:pointer;transition:all 0.2s;text-decoration:none;letter-spacing:0.01em;}
.btn-primary{background:var(--accent);color:#000;width:100%;}
.btn-primary:hover{background:#00cc6e;transform:translateY(-1px);}
.btn-primary:disabled{background:#334;color:#666;cursor:not-allowed;transform:none;}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
.btn-danger{background:rgba(255,51,102,0.15);color:var(--accent2);border:1px solid rgba(255,51,102,0.3);}
.btn-danger:hover{background:rgba(255,51,102,0.25);}
.btn-sm{padding:8px 15px;font-size:0.8rem;}
.alert{padding:12px 16px;border-radius:9px;margin-bottom:14px;font-size:0.85rem;display:flex;align-items:center;gap:8px;line-height:1.4;}
.alert-error{background:rgba(255,51,102,0.1);border:1px solid rgba(255,51,102,0.25);color:var(--accent2);}
.alert-success{background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.25);color:var(--accent);}
.alert-info{background:rgba(51,136,255,0.1);border:1px solid rgba(51,136,255,0.25);color:var(--accent3);}
.alert-warning{background:rgba(255,170,0,0.1);border:1px solid rgba(255,170,0,0.25);color:var(--warning);}
/* DASHBOARD */
.dash{max-width:1200px;margin:0 auto;padding:36px 24px;}
.dash-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:36px;flex-wrap:wrap;gap:16px;}
.dash-top h2{font-size:1.7rem;font-weight:800;letter-spacing:-0.03em;}
.dash-top h2 small{font-size:0.8rem;color:var(--muted);font-weight:400;display:block;margin-top:4px;font-family:'JetBrains Mono',monospace;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:28px;}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:22px;position:relative;overflow:hidden;}
.stat::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.stat.g::after{background:var(--accent);} .stat.b::after{background:var(--accent3);} .stat.y::after{background:var(--warning);} .stat.r::after{background:var(--accent2);}
.stat-v{font-size:2rem;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1;margin-bottom:5px;}
.stat-l{font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:15px;padding:26px;margin-bottom:22px;}
.card-title{font-size:0.85rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:18px;display:flex;align-items:center;gap:10px;}
.badge-live{background:rgba(0,255,136,0.15);color:var(--accent);padding:2px 9px;border-radius:20px;font-size:0.68rem;animation:pulse 2s infinite;}
/* QR section */
.qr-grid{display:grid;grid-template-columns:1fr 1fr;gap:22px;align-items:start;}
@media(max-width:720px){.qr-grid{grid-template-columns:1fr;}}
.qr-box{background:var(--surface2);border:1px solid var(--accent);border-radius:15px;padding:28px;text-align:center;position:relative;}
.qr-img-wrap{display:inline-block;padding:14px;background:#fff;border-radius:10px;margin-bottom:14px;}
.qr-img-wrap img{width:220px;height:220px;display:block;}
.qr-timer{font-family:'JetBrains Mono',monospace;font-size:2.2rem;font-weight:700;color:var(--accent);margin-bottom:6px;transition:color 0.3s;}
.qr-timer.warn{color:var(--warning);} .qr-timer.danger{color:var(--accent2);}
.qr-sub{font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.prog-bar{height:3px;background:var(--surface);border-radius:2px;overflow:hidden;margin-top:10px;}
.prog-fill{height:100%;background:var(--accent);transition:width 1s linear,background 0.3s;}
.token-pill{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--muted);word-break:break-all;margin-top:10px;padding:7px;background:var(--surface);border-radius:7px;text-align:left;}
/* Tables */
.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:0.85rem;}
th{text-align:left;padding:9px 14px;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);border-bottom:1px solid var(--border);}
td{padding:13px 14px;border-bottom:1px solid rgba(255,255,255,0.04);}
tr:last-child td{border-bottom:none;} tr:hover td{background:rgba(255,255,255,0.02);}
.pill{display:inline-block;padding:2px 9px;border-radius:20px;font-size:0.68rem;font-weight:700;font-family:'JetBrains Mono',monospace;}
.pill-g{background:rgba(0,255,136,0.13);color:var(--accent);}
.pill-r{background:rgba(255,51,102,0.13);color:var(--accent2);}
.pill-y{background:rgba(255,170,0,0.13);color:var(--warning);}
.pill-b{background:rgba(51,136,255,0.13);color:var(--accent3);}
/* Classes list */
.cls-card{background:var(--surface2);border:1px solid var(--border);border-radius:11px;padding:18px 20px;display:flex;align-items:center;gap:14px;margin-bottom:10px;transition:border-color 0.2s;}
.cls-card:hover{border-color:var(--accent);}
.cls-icon{width:44px;height:44px;border-radius:10px;background:rgba(0,255,136,0.08);display:grid;place-items:center;font-size:18px;flex-shrink:0;}
.cls-info{flex:1;} .cls-info h3{font-size:0.95rem;font-weight:700;margin-bottom:3px;} .cls-info p{font-size:0.73rem;color:var(--muted);}
.tabs-row{display:flex;gap:4px;margin-bottom:22px;background:var(--surface2);padding:4px;border-radius:10px;width:fit-content;}
.tab-btn{padding:9px 18px;border:none;border-radius:7px;background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-weight:600;font-size:0.85rem;cursor:pointer;transition:all 0.2s;letter-spacing:0.01em;}
.tab-btn.active{background:var(--surface);color:var(--text);}
.tab-panel{display:none;} .tab-panel.active{display:block;}
.empty{text-align:center;padding:40px 20px;color:var(--muted);}
.empty .ei{font-size:2.4rem;margin-bottom:12px;}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.ml-auto{margin-left:auto;}
.mt{margin-top:14px;}
.logout-btn{background:none;border:1px solid var(--border);color:var(--muted);padding:7px 14px;border-radius:7px;cursor:pointer;font-family:'Outfit',sans-serif;font-size:0.8rem;font-weight:600;transition:all 0.2s;letter-spacing:0.02em;}
.logout-btn:hover{border-color:var(--accent2);color:var(--accent2);}
/* STUDENT SCAN PAGE */
.scan-wrap{min-height:calc(100vh - 61px);display:flex;align-items:center;justify-content:center;padding:40px 20px;}
.scan-box{width:100%;max-width:460px;text-align:center;}
.scan-box h2{font-size:1.8rem;font-weight:800;margin-bottom:8px;}
.scan-box p{color:var(--muted);margin-bottom:28px;font-size:0.9rem;line-height:1.5;}
.scan-result{padding:20px;border-radius:11px;margin-top:18px;font-weight:700;font-size:1rem;display:none;}
.scan-result.ok{background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);color:var(--accent);}
.scan-result.fail{background:rgba(255,51,102,0.1);border:1px solid rgba(255,51,102,0.3);color:var(--accent2);}
.spinner{display:inline-block;width:18px;height:18px;border:2px solid rgba(0,0,0,0.3);border-top-color:#000;border-radius:50%;animation:spin 0.7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
@media(max-width:600px){header{padding:14px 18px;}.dash{padding:20px 14px;}}
</style>
</head>
<body>
<div class="grid-bg"></div>
<div class="app">

<header>
  <div class="logo"><div class="logo-icon">ğŸ›¡</div>QR<span>Shield</span></div>
  <div class="hdr-right">
    <div style="display:flex;align-items:center;gap:6px;"><div class="dot"></div><span>SECURE</span></div>
    <span id="hdr-user" style="display:none;"></span>
    <button class="logout-btn" id="hdr-logout" style="display:none;" onclick="logout()">Logout</button>
  </div>
</header>

<!-- â•â• LOGIN VIEW â•â• -->
<div id="view-login" class="view active">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="auth-hero">
        <h1>Attendance That<br>Can't Be <em>Cheated</em></h1>
        <p>Cryptographic QR tokens that expire in 30 seconds.<br>Teacher dashboard. No student accounts needed.</p>
      </div>
      <div class="auth-card">
        <div id="login-alert"></div>
        <div class="fg"><label>Teacher Email</label><input type="email" id="l-email" placeholder="teacher@demo.com" /></div>
        <div class="fg"><label>Password</label><input type="password" id="l-pass" placeholder="teacher123" /></div>
        <div class="alert alert-info" style="margin-bottom:16px;">ğŸ’¡ Demo: <strong>teacher@demo.com / teacher123</strong></div>
        <button class="btn btn-primary" id="login-btn" onclick="doLogin()">Login â†’</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â• TEACHER DASHBOARD â•â• -->
<div id="view-dash" class="view">
  <div class="dash">
    <div class="dash-top">
      <h2>Teacher Dashboard <small id="dash-name"></small></h2>
      <div class="flex">
        <div class="tabs-row">
          <button class="tab-btn active" onclick="switchTab('tab-classes')">Classes</button>
          <button class="tab-btn" onclick="switchTab('tab-reports')">Reports</button>
          <button class="tab-btn" onclick="switchTab('tab-fraud')">Fraud Log</button>
        </div>
      </div>
    </div>

    <div class="stats">
      <div class="stat g"><div class="stat-v" id="s-attend">0</div><div class="stat-l">Total Attendances</div></div>
      <div class="stat b"><div class="stat-v" id="s-sess">0</div><div class="stat-l">Active Sessions</div></div>
      <div class="stat y"><div class="stat-v" id="s-class">0</div><div class="stat-l">Classes</div></div>
      <div class="stat r"><div class="stat-v" id="s-fraud">0</div><div class="stat-l">Fraud Attempts</div></div>
    </div>

    <!-- â”€â”€ Tab: Classes â”€â”€ -->
    <div id="tab-classes" class="tab-panel active">
      <!-- Active QR session -->
      <div id="qr-card" class="card" style="display:none;">
        <div class="card-title">ğŸ“¡ Live Session â€” <span id="qr-class-name" style="color:var(--accent)"></span> <span class="badge-live">LIVE</span></div>
        <div class="qr-grid">
          <div class="qr-box">
            <div class="qr-img-wrap"><img id="qr-img" src="" alt="QR Code" /></div>
            <div class="qr-timer" id="qr-timer">7</div>
            <div class="qr-sub">seconds until next QR</div>
            <div class="prog-bar"><div class="prog-fill" id="qr-prog" style="width:100%"></div></div>
            <div class="token-pill" id="qr-token-snip">Generating secure token...</div>
          </div>
          <div>
            <div class="card" style="margin-bottom:14px;">
              <div class="card-title">ğŸ” Security Active</div>
              <div style="font-size:0.8rem;line-height:2;color:var(--muted);">
                âœ… HMAC-SHA256 signed on server<br>
                âœ… Secret key never sent to client<br>
                âœ… 30-second hard expiry<br>
                âœ… Random nonce per token<br>
                âœ… One-time use enforced<br>
                âœ… Rate limiting (3 req/10s)<br>
                âœ… Replay attacks blocked<br>
                âœ… One submission per device<br>
                âœ… One submission per IP<br>
                âœ… Shared links invalidated<br>
                âœ… Spoof farm detection<br>
                âœ… URL token cleared after load<br>
                âœ… F5 re-submit blocked<br>
                <span id="loc-status-line">ğŸ“ Capturing teacher location...</span>
              </div>
            </div>
            <div class="card" style="margin-bottom:14px;">
              <div class="card-title">ğŸ‘¥ Live Scans <span id="scan-count" style="color:var(--accent);font-family:'JetBrains Mono',monospace;">0</span></div>
              <div id="live-list"><div class="empty"><div class="ei">ğŸ“‹</div><p>Waiting for studentsâ€¦</p></div></div>
            </div>
            <button class="btn btn-danger" style="width:100%;" onclick="stopSession()">â¹ Stop Session</button>
          </div>
        </div>
      </div>

      <!-- Create class -->
      <div class="card">
        <div class="card-title">â• Create Class</div>
        <div class="flex">
          <input type="text" id="cls-name-input" placeholder="e.g. CS101 â€” Data Structures" style="flex:1;padding:12px 15px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'Sora',sans-serif;outline:none;">
          <button class="btn btn-primary" style="width:auto;" onclick="createClass()">Create</button>
        </div>
      </div>

      <!-- Classes list -->
      <div class="card">
        <div class="card-title">ğŸ“š Your Classes</div>
        <div id="classes-list"><div class="empty"><div class="ei">ğŸ“­</div><p>No classes yet.</p></div></div>
      </div>
    </div>

    <!-- â”€â”€ Tab: Reports â”€â”€ -->
    <div id="tab-reports" class="tab-panel">
      <div class="card">
        <div class="card-title" style="justify-content:space-between;flex-wrap:wrap;gap:10px;">
          <span>ğŸ“Š Attendance Report</span>
          <div class="flex" style="gap:8px;">
            <select id="report-filter-class" onchange="renderReports()" style="padding:7px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Outfit',sans-serif;font-size:0.82rem;outline:none;cursor:pointer;">
              <option value="">All Subjects</option>
            </select>
            <button class="btn btn-secondary btn-sm" onclick="toggleReportView()" id="report-view-btn">ğŸ“‹ Group by Subject</button>
          </div>
        </div>
        <div id="report-grouped" style="display:none;"></div>
        <div id="report-flat" style="display:block;">
          <div class="tbl-wrap">
            <table>
              <thead><tr><th>Student Name</th><th>Student ID</th><th>Subject</th><th>Time Marked</th><th>Status</th><th>ğŸ“ Proximity</th><th>Action</th></tr></thead>
              <tbody id="report-tbody"></tbody>
            </table>
          </div>
        </div>
        <div id="report-empty" class="empty"><div class="ei">ğŸ“ˆ</div><p>No records yet.</p></div>
      </div>
    </div>

    <!-- â”€â”€ Tab: Fraud â”€â”€ -->
    <div id="tab-fraud" class="tab-panel">
      <div class="card">
        <div class="card-title" style="justify-content:space-between;flex-wrap:wrap;gap:10px;">
          <span>ğŸš¨ Fraud & Abuse Log</span>
          <button class="btn btn-danger btn-sm" onclick="clearAllFraud()">ğŸ—‘ Clear All</button>
        </div>
        <div class="alert alert-warning" style="margin-bottom:16px;">All rejected token attempts logged here â€” expired, replayed, tampered, rate-limited.</div>
        <div class="tbl-wrap">
          <table>
            <thead><tr><th>Time</th><th>Reason</th><th>Student</th><th>Token (snippet)</th><th>Action</th></tr></thead>
            <tbody id="fraud-tbody"></tbody>
          </table>
        </div>
        <div id="fraud-empty" class="empty"><div class="ei">âœ…</div><p>No fraud detected.</p></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• STUDENT SCAN VIEW â•â• -->
<div id="view-scan" class="view">
  <div class="scan-wrap">
    <div class="scan-box">

      <!-- â”€â”€ Blocked screen â€” shown when link is shared / invalid / expired â”€â”€ -->
      <div id="scan-blocked" style="display:none;">
        <div style="font-size:4rem;margin-bottom:16px;">ğŸš«</div>
        <h2 style="color:var(--accent2);margin-bottom:12px;" id="scan-blocked-title">Link Invalid</h2>
        <div class="auth-card" style="text-align:left;margin-top:24px;border-color:rgba(255,51,102,0.4);">
          <div class="alert alert-error" id="scan-blocked-msg" style="font-size:0.95rem;line-height:1.7;"></div>
          <div style="font-size:0.82rem;color:var(--muted);line-height:1.7;margin-top:8px;">
            ğŸ”’ Each QR link is single-use and bound to the first device that opens it.<br>
            ğŸ“± To mark your attendance, <strong style="color:var(--text);">scan the QR code directly</strong> from the projector/screen with your own device's camera.<br>
            â± QR codes refresh every 30 seconds â€” scan the latest one shown on screen.
          </div>
        </div>
      </div>

      <!-- â”€â”€ Normal form â€” shown when link is valid â”€â”€ -->
      <div id="scan-form">
        <div style="font-size:3rem;margin-bottom:16px;">ğŸ“·</div>
        <h2>Mark Attendance</h2>
        <p>Enter your details below.<br>The token from the QR code is in the URL automatically.</p>
        <div class="auth-card" style="text-align:left;margin-top:24px;">
          <div id="scan-alert"></div>
          <div class="fg"><label>Your Full Name</label><input type="text" id="sc-name" placeholder="John Doe" /></div>
          <div class="fg"><label>Your Student ID</label><input type="text" id="sc-sid" placeholder="e.g. STU-2024-001" /></div>
          <input type="hidden" id="sc-token" />
          <div class="alert alert-info" style="margin-bottom:16px;" id="sc-token-status">â³ Reading token from URL...</div>
          <button class="btn btn-primary" id="scan-btn" onclick="doScan()">âœ“ Mark Present</button>
        </div>
        <div id="scan-result" class="scan-result"></div>
      </div>

    </div>
  </div>
</div>

</div><!-- /.app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QRShield Frontend â€” talks to Express backend via REST API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = ''; // same origin â€” backend serves this file

let authToken = localStorage.getItem('qrs_token');
let currentTeacher = JSON.parse(localStorage.getItem('qrs_teacher') || 'null');
let activeSessionId = null;
let qrInterval = null;
let countdown = null;
let countSec = 30;
let allReportRecords = [];
let reportViewGrouped = false;

// â”€â”€ ROUTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function route() {
  const params = new URLSearchParams(window.location.search);
  const token = params.get('t');

  if (token) {
    // Student landed here from QR scan
    showView('view-scan');
    document.getElementById('sc-token').value = token;

    // â”€â”€ Replace the token in the URL bar with a clean path so students
    // can't copy-paste the link and share it after the page loads.
    try {
      window.history.replaceState({}, '', window.location.pathname);
    } catch(e) {}

    const statusEl = document.getElementById('sc-token-status');
    const btn = document.getElementById('scan-btn');

    // â”€â”€ F5 / reload re-submit prevention: check if already submitted this session
    // We use the first 16 chars of the token as a session hint (unique per QR cycle)
    const sessionHint = token.slice(0, 16);
    if (hasSubmitted(sessionHint)) {
      statusEl.className = 'alert alert-success';
      statusEl.textContent = 'âœ… Your attendance has already been marked for this session.';
      if (btn) { btn.disabled = true; btn.textContent = 'âœ“ Already Submitted'; }
      document.getElementById('sc-name').disabled = true;
      document.getElementById('sc-sid').disabled = true;
      return;
    }

    // â”€â”€ Claim the token + start GPS in parallel immediately.
    // GPS starts right away (doesn't wait for claim) to maximise location fix time.
    // Claim runs concurrently â€” if it fails, form is disabled after the fact.
    startEarlyGPS(); // start GPS immediately â€” no need to wait for claim
    (async () => {
      try {
        await api('POST', '/api/attendance/claim', { token, deviceId: getDeviceId() });
        // Claim succeeded â€” form stays enabled, GPS status already shown
      } catch(e) {
        const msg = e.message || '';
        if (msg.includes('already been opened') || msg.includes('different device')) {
          showBlockedScreen(
            'ğŸ”— Shared Link Detected',
            'â›” This QR link has already been opened on <strong>another device</strong>.<br><br>' +
            'Someone shared this link with you â€” but that is not allowed.<br><br>' +
            'You must <strong>scan the QR code directly</strong> from the classroom screen with your own camera.'
          );
        } else if (msg.includes('expired') || msg.includes('Invalid or expired')) {
          showBlockedScreen(
            'â± QR Code Expired',
            'âŒ› This QR code has <strong>expired</strong> before you could open it.<br><br>' +
            'QR codes refresh every 30 seconds. Please <strong>scan the latest QR code</strong> shown on the classroom screen.'
          );
        } else if (msg.includes('Suspicious') || msg.includes('farm')) {
          showBlockedScreen(
            'ğŸš¨ Suspicious Activity',
            'â›” Suspicious activity detected from your network.<br><br>' +
            'Please contact your teacher if you believe this is a mistake.'
          );
        } else {
          showBlockedScreen(
            'âŒ Link Invalid',
            'â›” ' + msg + '<br><br>Please <strong>scan the QR code directly</strong> from the classroom screen.'
          );
        }
      }
    })();
    return;
  }

  if (authToken && currentTeacher) {
    showView('view-dash');
    document.getElementById('hdr-user').textContent = currentTeacher.name;
    document.getElementById('hdr-user').style.display = 'inline';
    document.getElementById('hdr-logout').style.display = 'inline-flex';
    document.getElementById('dash-name').textContent = `â€” ${currentTeacher.name}`;
    refreshDashboard();
  } else {
    showView('view-login');
  }
}

// â”€â”€ API HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(method, path, body) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' },
  };
  if (authToken) opts.headers['Authorization'] = `Bearer ${authToken}`;
  if (body) opts.body = JSON.stringify(body);
  let res;
  try {
    res = await fetch(API + path, opts);
  } catch (networkErr) {
    throw new Error('Network error â€” check your connection and try again.');
  }
  const data = await res.json().catch(() => ({}));
  if (res.status === 401) {
    // Auto-logout on expired/invalid token (only on authenticated requests)
    if (authToken && path !== '/api/auth/login') {
      logout();
      throw new Error('Session expired. Please log in again.');
    }
  }
  if (!res.ok) throw new Error(data.error || `Request failed (${res.status})`);
  return data;
}

function showAlert(id, msg, type = 'error') {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => { el.innerHTML = ''; }, 5000);
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const email = document.getElementById('l-email').value.trim();
  const pass = document.getElementById('l-pass').value;
  if (!email || !pass) return showAlert('login-alert', 'âŒ Fill all fields');
  const btn = document.getElementById('login-btn');
  btn.innerHTML = '<div class="spinner"></div>';
  btn.disabled = true;
  try {
    const data = await api('POST', '/api/auth/login', { email, password: pass });
    authToken = data.token;
    currentTeacher = data.teacher;
    localStorage.setItem('qrs_token', authToken);
    localStorage.setItem('qrs_teacher', JSON.stringify(currentTeacher));
    startDashRefresh();
    route();
  } catch(e) {
    showAlert('login-alert', 'âŒ ' + e.message);
    btn.innerHTML = 'Login â†’';
    btn.disabled = false;
  }
}

function logout() {
  stopQRCycle();
  stopAttendeePoll();
  if (dashRefreshInterval) { clearInterval(dashRefreshInterval); dashRefreshInterval = null; }
  authToken = null;
  currentTeacher = null;
  activeSessionId = null;
  allReportRecords = [];
  localStorage.removeItem('qrs_token');
  localStorage.removeItem('qrs_teacher');
  document.getElementById('hdr-user').style.display = 'none';
  document.getElementById('hdr-logout').style.display = 'none';
  showView('view-login');
}

// â”€â”€ CLASSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createClass() {
  const name = document.getElementById('cls-name-input').value.trim();
  if (!name) return;
  try {
    await api('POST', '/api/classes', { name });
    document.getElementById('cls-name-input').value = '';
    refreshDashboard();
  } catch(e) { alert(e.message); }
}

async function startSession(classId) {
  if (activeSessionId) return alert('Stop the current session first.');

  // Capture teacher GPS location before starting
  let teacherLat = null, teacherLng = null;
  try {
    const pos = await new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
      navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 8000, enableHighAccuracy: true });
    });
    teacherLat = pos.coords.latitude;
    teacherLng = pos.coords.longitude;
  } catch(e) {
    const isHttps = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const reason = !isHttps
      ? 'ğŸ”’ This app is running over HTTP (not HTTPS) â€” browsers block GPS on HTTP.\n\nTo enable proximity enforcement, deploy with HTTPS (e.g. Render, Railway, ngrok).\n\n'
      : 'ğŸ“ Location permission was denied or timed out.\n\n';
    const proceed = confirm(reason + 'Proximity enforcement will be DISABLED for this session â€” students can mark attendance from anywhere.\n\nProceed without location?');
    if (!proceed) return;
  }

  try {
    const body = { classId };
    if (teacherLat != null) { body.teacherLat = teacherLat; body.teacherLng = teacherLng; }
    const data = await api('POST', '/api/sessions/start', body);
    activeSessionId = data.sessionId;
    document.getElementById('qr-card').style.display = 'block';
    document.getElementById('qr-class-name').textContent = data.className;
    // Update security panel location status using teacherLocation field
    const locLine = document.getElementById('loc-status-line');
    if (locLine) {
      if (data.teacherLocation) {
        locLine.innerHTML = 'âœ… Proximity check active (30m limit)';
        locLine.style.color = 'var(--accent)';
      } else {
        locLine.innerHTML = 'âš ï¸ Proximity check disabled (no location)';
        locLine.style.color = 'var(--warning)';
      }
    }
    startQRCycle();
    startAttendeePoll();
    refreshDashboard();
  } catch(e) { alert(e.message); }
}

async function stopSession() {
  if (!activeSessionId) return;
  try {
    await api('POST', `/api/sessions/${activeSessionId}/stop`);
    stopQRCycle();
    stopAttendeePoll();
    activeSessionId = null;
    document.getElementById('qr-card').style.display = 'none';
    refreshDashboard();
  } catch(e) { alert(e.message); }
}

// â”€â”€ QR CYCLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startQRCycle() {
  fetchQR();
  countSec = 30;
  qrInterval = setInterval(fetchQR, 30000);
  countdown = setInterval(() => {
    countSec--;
    const el = document.getElementById('qr-timer');
    if (el) {
      el.textContent = countSec;
      el.className = 'qr-timer' + (countSec <= 5 ? ' danger' : countSec <= 10 ? ' warn' : '');
    }
    const prog = document.getElementById('qr-prog');
    if (prog) {
      prog.style.width = ((countSec / 30) * 100) + '%';
      prog.style.background = countSec <= 5 ? 'var(--accent2)' : countSec <= 10 ? 'var(--warning)' : 'var(--accent)';
    }
  }, 1000);
}

function stopQRCycle() {
  clearInterval(qrInterval);
  clearInterval(countdown);
  qrInterval = null;
  countdown = null;
  countSec = 30;
}

async function fetchQR() {
  if (!activeSessionId) return;
  try {
    const data = await api('GET', `/api/sessions/${activeSessionId}/qr`);
    const img = document.getElementById('qr-img');
    if (img) img.src = data.qr; // backend returns { qr, token, ... }
    const snip = document.getElementById('qr-token-snip');
    if (snip && data.token) snip.textContent = data.token.substring(0, 64) + 'â€¦';
    countSec = 30; // reset countdown exactly on new QR
  } catch(e) {
    console.error('QR fetch failed:', e.message);
  }
}

async function fetchAttendees() {
  if (!activeSessionId) return;
  try {
    const data = await api('GET', `/api/sessions/${activeSessionId}/attendees`);
    document.getElementById('scan-count').textContent = data.count;
    const list = document.getElementById('live-list');
    if (!data.attendees.length) {
      list.innerHTML = '<div class="empty"><div class="ei">ğŸ“‹</div><p>Waiting for studentsâ€¦</p></div>';
    } else {
      list.innerHTML = data.attendees.map(a => `
        <div style="display:flex;align-items:center;gap:12px;padding:9px 0;border-bottom:1px solid var(--border);">
          <div style="width:34px;height:34px;border-radius:8px;background:rgba(0,255,136,0.1);display:grid;place-items:center;">ğŸ‘¤</div>
          <div>
            <div style="font-weight:700;font-size:0.87rem;">${a.studentName}</div>
            <div style="font-size:0.7rem;color:var(--muted);font-family:'JetBrains Mono',monospace;">${a.studentId} Â· ${new Date(a.markedAt).toLocaleTimeString()}</div>
          </div>
          <span class="pill pill-g ml-auto">âœ“ PRESENT</span>
        </div>`).join('');
    }
  } catch(e) {}
}

// â”€â”€ DASHBOARD REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let attendeePollInterval = null;

async function refreshDashboard() {
  try {
    const [classesData, reportsData, fraudData, sessData] = await Promise.all([
      api('GET', '/api/classes'),
      api('GET', '/api/attendance/report'),
      api('GET', '/api/attendance/fraud'),
      api('GET', '/api/sessions'),
    ]);

    // â”€â”€ Correct response shapes: classes={classes:[]}, sessions={sessions:[]}
    const classList = classesData.classes || [];
    const sessionList = sessData.sessions || [];
    const reportRecords = reportsData.records || [];

    // Stats
    document.getElementById('s-attend').textContent = reportsData.count || 0;
    document.getElementById('s-class').textContent = classList.length;
    document.getElementById('s-fraud').textContent = fraudData.count || 0;
    const activeSessCount = sessionList.filter(s => s.active).length;
    document.getElementById('s-sess').textContent = activeSessCount;

    // Classes list
    const clsList = document.getElementById('classes-list');
    if (!classList.length) {
      clsList.innerHTML = '<div class="empty"><div class="ei">ğŸ“­</div><p>No classes yet.</p></div>';
    } else {
      clsList.innerHTML = classList.map(cls => {
        const isLive = sessionList.some(s => s.classId === cls.id && s.active);
        return `<div class="cls-card">
          <div class="cls-icon">${isLive ? 'ğŸ“¡' : 'ğŸ“š'}</div>
          <div class="cls-info">
            <h3>${cls.name}</h3>
            <p>Sessions: ${cls.sessionCount || 0} &nbsp;|&nbsp; Attendances: ${cls.totalAttendance || 0}</p>
          </div>
          ${isLive
            ? `<span class="pill pill-g" style="margin-right:6px;">LIVE</span>`
            : `<button class="btn btn-secondary btn-sm" onclick="startSession('${cls.id}')">â–¶ Start</button>`}
          <button class="btn btn-danger btn-sm" onclick="deleteClass('${cls.id}', event)">ğŸ—‘</button>
        </div>`;
      }).join('');
    }

    // Store records globally (backend already sorted newest-first â€” no reversal needed)
    allReportRecords = reportRecords;

    // Populate subject filter, preserving current selection
    const filterSel = document.getElementById('report-filter-class');
    const prevFilter = filterSel.value;
    const subjects = [...new Map(reportRecords.map(r => [r.classId, r.className])).entries()];
    filterSel.innerHTML = '<option value="">All Subjects</option>' +
      subjects.map(([id, name]) => `<option value="${id}">${name}</option>`).join('');
    // Restore previous selection if still valid
    if (prevFilter && subjects.some(([id]) => id === prevFilter)) filterSel.value = prevFilter;

    renderReports();

    // Fraud log
    renderFraudLog(fraudData.logs);

  } catch(e) {
    console.error('Dashboard refresh error:', e.message);
    // Auto-logout already handled in api() on 401
  }
}

// â”€â”€ Start polling attendees every 5s during live session
function startAttendeePoll() {
  if (attendeePollInterval) clearInterval(attendeePollInterval);
  fetchAttendees();
  attendeePollInterval = setInterval(fetchAttendees, 5000);
}
function stopAttendeePoll() {
  if (attendeePollInterval) { clearInterval(attendeePollInterval); attendeePollInterval = null; }
}

// â”€â”€ REPORTS RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReports() {
  const filterClassId = document.getElementById('report-filter-class').value;
  const records = filterClassId
    ? allReportRecords.filter(r => r.classId === filterClassId)
    : allReportRecords;

  document.getElementById('report-empty').style.display = records.length ? 'none' : 'block';

  if (reportViewGrouped) {
    document.getElementById('report-flat').style.display = 'none';
    document.getElementById('report-grouped').style.display = 'block';
    // Group by classId
    const groups = {};
    records.forEach(r => {
      if (!groups[r.classId]) groups[r.classId] = { name: r.className, records: [] };
      groups[r.classId].records.push(r);
    });
    document.getElementById('report-grouped').innerHTML = Object.values(groups).map(g => `
      <div style="margin-bottom:22px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border);">
          <span style="font-size:1rem;">ğŸ“š</span>
          <strong style="font-size:0.95rem;">${g.name}</strong>
          <span class="pill pill-b">${g.records.length} student${g.records.length !== 1 ? 's' : ''}</span>
        </div>
        <div class="tbl-wrap">
          <table>
            <thead><tr><th>Student Name</th><th>Student ID</th><th>Time Marked</th><th>Status</th><th>Action</th></tr></thead>
            <tbody>
              ${g.records.map(r => `
              <tr>
                <td><strong>${r.studentName}</strong></td>
                <td><span style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;">${r.studentId}</span></td>
                <td><span style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;">${new Date(r.markedAt).toLocaleString()}</span></td>
                <td><span class="pill pill-g">PRESENT</span></td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteAttendance('${r.id}')">ğŸ—‘ Remove</button></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>`).join('') || '<div class="empty"><div class="ei">ğŸ“ˆ</div><p>No records for this subject.</p></div>';
  } else {
    document.getElementById('report-grouped').style.display = 'none';
    document.getElementById('report-flat').style.display = 'block';
    document.getElementById('report-tbody').innerHTML = records.map(r => {
      let proxCell;
      if (r.locationStatus === 'not_required') {
        proxCell = `<span class="pill pill-b" title="No location was set for this session">N/A</span>`;
      } else if (r.locationStatus === 'verified') {
        proxCell = `<span class="pill pill-g" title="${r.distanceMeters}m from classroom">âœ“ ${r.distanceMeters}m</span>`;
      } else {
        proxCell = `<span class="pill pill-y" title="Location not shared by student">âš  Unverified</span>`;
      }
      return `<tr>
        <td><strong>${r.studentName}</strong></td>
        <td><span style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;">${r.studentId}</span></td>
        <td><span class="pill pill-b" style="font-size:0.72rem;">${r.className}</span></td>
        <td><span style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;">${new Date(r.markedAt).toLocaleString()}</span></td>
        <td><span class="pill pill-g">PRESENT</span></td>
        <td>${proxCell}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteAttendance('${r.id}')">ğŸ—‘</button></td>
      </tr>`;
    }).join('');
  }
}

function toggleReportView() {
  reportViewGrouped = !reportViewGrouped;
  document.getElementById('report-view-btn').textContent = reportViewGrouped ? 'ğŸ“„ Flat View' : 'ğŸ“‹ Group by Subject';
  renderReports();
}

async function deleteAttendance(id) {
  if (!confirm('Remove this attendance record? This cannot be undone.')) return;
  try {
    await api('DELETE', `/api/attendance/${id}`);
    allReportRecords = allReportRecords.filter(r => r.id !== id);
    renderReports();
    // Update total count stat
    document.getElementById('s-attend').textContent = allReportRecords.length;
  } catch(e) { alert(e.message); }
}

async function deleteClass(id, e) {
  if (e) e.stopPropagation();
  if (!confirm('Delete this class? This will also remove all its attendance records.')) return;
  try { await api('DELETE', `/api/classes/${id}`); refreshDashboard(); } catch(e) { alert(e.message); }
}

// â”€â”€ STUDENT SCAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GPS is captured eagerly on page load so it's ready before the student clicks submit.
let _studentLat = null, _studentLng = null;
let _gpsReady = false;        // true = we have coords
let _gpsSkipped = false;      // true = geo unavailable / denied
let _gpsPromise = null;       // resolves when GPS attempt is complete

// â”€â”€ DEVICE ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// A persistent UUID stored in BOTH localStorage AND sessionStorage.
// Using both means:
//   - localStorage: survives page close/reopen (catches "clear and reopen" trick)
//   - sessionStorage: survives localStorage.clear() within the same tab session
// If a student clears localStorage mid-session, sessionStorage still holds the ID
// and the backend will reject the second attempt via deviceSessions map.
function getDeviceId() {
  // Try sessionStorage first (survives localStorage.clear() in same tab)
  let id = sessionStorage.getItem('qrs_device_id') || localStorage.getItem('qrs_device_id');
  if (!id) {
    // Generate a cryptographically random UUID
    const arr = new Uint8Array(16);
    crypto.getRandomValues(arr);
    arr[6] = (arr[6] & 0x0f) | 0x40; // version 4
    arr[8] = (arr[8] & 0x3f) | 0x80; // variant
    id = 'dev_' + [...arr].map((b, i) =>
      ([4,6,8,10].includes(i) ? '-' : '') + b.toString(16).padStart(2, '0')
    ).join('');
  }
  // Write to both storages â€” whichever survives is enough
  try { localStorage.setItem('qrs_device_id', id); } catch(e) {}
  try { sessionStorage.setItem('qrs_device_id', id); } catch(e) {}
  return id;
}

// â”€â”€ ANTI-DEVTOOLS / localStorage.clear() DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Watch for storage events â€” if qrs_device_id is removed from localStorage,
// immediately restore it from sessionStorage so the deviceId stays consistent.
window.addEventListener('storage', (e) => {
  if (e.key === 'qrs_device_id' && e.newValue === null) {
    // localStorage was cleared â€” restore from sessionStorage
    const saved = sessionStorage.getItem('qrs_device_id');
    if (saved) {
      try { localStorage.setItem('qrs_device_id', saved); } catch(ex) {}
    }
  }
});

// â”€â”€ BLOCKED SCREEN â€” replaces the form with a full error screen â”€
function showBlockedScreen(title, message) {
  document.getElementById('scan-form').style.display = 'none';
  document.getElementById('scan-blocked').style.display = 'block';
  document.getElementById('scan-blocked-title').textContent = title;
  document.getElementById('scan-blocked-msg').innerHTML = message;
}

// â”€â”€ SUBMISSION STATE â€” persisted to sessionStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tracks whether this tab has already successfully submitted for a session.
// Survives F5 refresh. Prevents the page reload â†’ re-submit trick.
function markSubmitted(sessionHint) {
  try { sessionStorage.setItem('qrs_submitted_' + sessionHint, '1'); } catch(e) {}
}
function hasSubmitted(sessionHint) {
  return sessionStorage.getItem('qrs_submitted_' + sessionHint) === '1';
}

function startEarlyGPS() {
  const statusEl = document.getElementById('sc-token-status');
  const btn = document.getElementById('scan-btn');
  const isHttps = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

  // â”€â”€ GPS is MANDATORY â€” if unavailable, block the form immediately
  if (!isHttps) {
    _gpsSkipped = true;
    _gpsPromise = Promise.resolve();
    if (statusEl) {
      statusEl.className = 'alert alert-error';
      statusEl.innerHTML = 'âŒ <strong>Location blocked by browser.</strong> This page must be opened over HTTPS for GPS to work. Please scan the QR code again using a proper connection.';
    }
    if (btn) { btn.disabled = true; btn.textContent = 'âœ— Location Required'; }
    return;
  }

  if (!navigator.geolocation) {
    _gpsSkipped = true;
    _gpsPromise = Promise.resolve();
    if (statusEl) {
      statusEl.className = 'alert alert-error';
      statusEl.textContent = 'âŒ Your device does not support GPS. Location is required to mark attendance. Please use a different device.';
    }
    if (btn) { btn.disabled = true; btn.textContent = 'âœ— Location Required'; }
    return;
  }

  // Start GPS fetch immediately in background
  if (statusEl) {
    statusEl.className = 'alert alert-info';
    statusEl.textContent = 'ğŸ“ Detecting your location... Please allow location access when prompted.';
  }

  _gpsPromise = new Promise((resolve) => {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        _studentLat = pos.coords.latitude;
        _studentLng = pos.coords.longitude;
        _gpsReady = true;
        if (statusEl) {
          statusEl.className = 'alert alert-success';
          statusEl.textContent = 'âœ… Location captured. Fill in your details and submit.';
        }
        resolve();
      },
      (err) => {
        // GPS denied or failed â€” block the form, GPS is mandatory
        _gpsSkipped = true;
        const msg = err.code === 1
          ? 'âŒ Location permission denied. You must allow location access to mark attendance. Please refresh and allow location.'
          : 'âŒ Could not get your location (timed out). Please ensure GPS is enabled and try again.';
        if (statusEl) {
          statusEl.className = 'alert alert-error';
          statusEl.textContent = msg;
        }
        if (btn) { btn.disabled = true; btn.textContent = 'âœ— Location Required'; }
        resolve(); // resolve so doScan() doesn't hang â€” but form is disabled anyway
      },
      { timeout: 10000, enableHighAccuracy: true }
    );
  });
}

async function doScan() {
  const name = document.getElementById('sc-name').value.trim();
  const sid = document.getElementById('sc-sid').value.trim();
  const token = document.getElementById('sc-token').value.trim();
  if (!name || !sid) return showAlert('scan-alert', 'âŒ Fill all fields');
  if (!token) return showAlert('scan-alert', 'âŒ No token found in URL');

  const btn = document.getElementById('scan-btn');
  const statusEl = document.getElementById('sc-token-status');
  btn.disabled = true;

  // â”€â”€ F5 guard: double-check sessionStorage before submitting
  const sessionHint = token.slice(0, 16);
  if (hasSubmitted(sessionHint)) {
    statusEl.className = 'alert alert-success';
    statusEl.textContent = 'âœ… Your attendance has already been marked for this session.';
    btn.textContent = 'âœ“ Already Submitted';
    document.getElementById('sc-name').disabled = true;
    document.getElementById('sc-sid').disabled = true;
    return;
  }

  // If GPS is still in progress, wait for it (it had a head start since page load)
  if (!_gpsReady && !_gpsSkipped && _gpsPromise) {
    btn.innerHTML = '<div class="spinner" style="border-top-color:#000;"></div> Waiting for location...';
    statusEl.className = 'alert alert-info';
    statusEl.textContent = 'ğŸ“ Almost there â€” waiting for GPS fix...';
    await _gpsPromise;
  }

  // â”€â”€ GPS mandatory guard â€” if GPS failed/denied, block submission entirely
  if (_gpsSkipped || (!_gpsReady && _studentLat === null)) {
    statusEl.className = 'alert alert-error';
    statusEl.textContent = 'âŒ Location is required to mark attendance. Please allow GPS access and refresh the page.';
    btn.disabled = true;
    btn.textContent = 'âœ— Location Required';
    return;
  }

  btn.innerHTML = '<div class="spinner" style="border-top-color:#000;"></div> Submitting...';

  try {
    const payload = { token, studentName: name, studentId: sid, deviceId: getDeviceId() };
    if (_studentLat != null) { payload.studentLat = _studentLat; payload.studentLng = _studentLng; }
    const data = await api('POST', '/api/attendance/scan', payload);

    // â”€â”€ Mark submitted in sessionStorage FIRST before touching the DOM
    // This way even if the user instantly refreshes, it's recorded
    markSubmitted(sessionHint);

    const res = document.getElementById('scan-result');
    res.className = 'scan-result ok';
    res.innerHTML = `âœ… ${data.message}`;
    res.style.display = 'block';
    btn.style.display = 'none';
    statusEl.style.display = 'none';

    // â”€â”€ Lock the entire form permanently â€” no further submissions possible
    document.getElementById('sc-name').disabled = true;
    document.getElementById('sc-sid').disabled = true;

  } catch(e) {
    const msg = e.message || '';
    if (msg.includes('already been marked from this device') || msg.includes('DUPLICATE')) {
      showBlockedScreen(
        'âœ… Already Submitted',
        'ğŸ“‹ Attendance has already been marked from <strong>this device</strong> for this session.<br><br>' +
        'You cannot submit twice.'
      );
    } else if (msg.includes('network connection') || msg.includes('DUPLICATE_IP')) {
      showBlockedScreen(
        'âœ… Already Submitted',
        'ğŸ“‹ Attendance has already been marked from <strong>this network connection</strong> for this session.<br><br>' +
        'You cannot submit twice.'
      );
    } else if (msg.includes('different device') || msg.includes('opened on a different')) {
      showBlockedScreen(
        'ğŸ”— Shared Link Detected',
        'â›” This QR link was opened on a <strong>different device</strong>.<br><br>' +
        'You must <strong>scan the QR code directly</strong> from the classroom screen with your own camera.'
      );
    } else if (msg.includes('too far') || msg.includes('away') || msg.includes('TOO_FAR')) {
      showAlert('scan-alert', `ğŸ“ ${msg}`);
      statusEl.className = 'alert alert-warning';
      statusEl.textContent = 'ğŸ“ Move closer to the classroom and try again.';
      btn.innerHTML = 'âœ“ Mark Present';
      btn.disabled = false;
    } else if (msg.includes('Location is required') || msg.includes('GPS')) {
      showBlockedScreen(
        'ğŸ“ Location Required',
        'âŒ <strong>Location access is required</strong> to mark attendance.<br><br>' +
        'Please refresh the page, allow location access when prompted, and try again.'
      );
    } else if (msg.includes('expired') || msg.includes('QR code expired')) {
      showBlockedScreen(
        'â± QR Code Expired',
        'âŒ› The QR code <strong>expired</strong> before your submission was received.<br><br>' +
        'Please <strong>scan the latest QR code</strong> shown on the classroom screen and try again quickly.'
      );
    } else {
      showAlert('scan-alert', 'âŒ ' + msg);
      statusEl.className = 'alert alert-info';
      statusEl.textContent = 'ğŸ” Fix the issue above and try again.';
      btn.innerHTML = 'âœ“ Mark Present';
      btn.disabled = false;
    }
  }
}

// â”€â”€ FRAUD LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentFraudLogs = [];

function renderFraudLog(logs) {
  currentFraudLogs = logs || [];
  const tbody = document.getElementById('fraud-tbody');
  const empty = document.getElementById('fraud-empty');
  document.getElementById('s-fraud').textContent = currentFraudLogs.length;
  empty.style.display = currentFraudLogs.length ? 'none' : 'block';
  tbody.innerHTML = currentFraudLogs.slice(0, 100).map((f, idx) => `
    <tr>
      <td><span style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;">${new Date(f.time).toLocaleString()}</span></td>
      <td><span class="pill pill-r">${f.reason}</span></td>
      <td style="font-size:0.83rem;">${f.studentName || 'â€”'} <span style="color:var(--muted);font-size:0.72rem;">(${f.studentId || '?'})</span></td>
      <td><span style="font-family:'JetBrains Mono',monospace;font-size:0.68rem;color:var(--muted);">${f.tokenSnippet}</span></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteFraudEntry(${idx})">ğŸ—‘</button></td>
    </tr>`).join('');
}

async function clearAllFraud() {
  if (!currentFraudLogs.length) return alert('No fraud logs to clear.');
  if (!confirm(`Clear all ${currentFraudLogs.length} fraud log entries? This cannot be undone.`)) return;
  try {
    await api('DELETE', '/api/attendance/fraud/all');
    renderFraudLog([]);
  } catch(e) { alert(e.message); }
}

async function deleteFraudEntry(idx) {
  if (!confirm('Remove this fraud log entry?')) return;
  try {
    await api('DELETE', `/api/attendance/fraud/${idx}`);
    currentFraudLogs.splice(idx, 1);
    renderFraudLog(currentFraudLogs);
  } catch(e) { alert(e.message); }
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.target.classList.add('active');
  if (id === 'tab-reports' || id === 'tab-fraud') refreshDashboard();
}

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  const activeEl = document.activeElement;
  if (document.getElementById('view-login').classList.contains('active')) {
    doLogin();
  } else if (document.getElementById('view-scan').classList.contains('active')) {
    doScan();
  } else if (document.getElementById('view-dash').classList.contains('active')) {
    if (activeEl && activeEl.id === 'cls-name-input') createClass();
  }
});

// â”€â”€ AUTO-REFRESH dashboard every 30s while logged in â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let dashRefreshInterval = null;
function startDashRefresh() {
  if (dashRefreshInterval) clearInterval(dashRefreshInterval);
  dashRefreshInterval = setInterval(() => {
    if (authToken && document.getElementById('view-dash').classList.contains('active')) {
      refreshDashboard();
    }
  }, 30000);
}

// â”€â”€ JWT EXPIRY CHECK â€” verify token still valid on page focus â”€â”€â”€â”€â”€
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && authToken) {
    // Decode JWT expiry (no crypto needed â€” just check the exp claim)
    try {
      const payload = JSON.parse(atob(authToken.split('.')[1]));
      if (payload.exp && Date.now() / 1000 > payload.exp) {
        logout();
        showAlert('login-alert', 'â° Your session expired. Please log in again.', 'warning');
      }
    } catch(e) { /* malformed token â€” ignore */ }
  }
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
route();
if (authToken) startDashRefresh();
</script>
</body>
</html>
